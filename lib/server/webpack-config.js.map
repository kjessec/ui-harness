{"version":3,"sources":["../../src/server/webpack-config.js"],"names":["NODE_MODULES_PATH","join","UIHARNESS_ENTRY","__dirname","global","self","fetch","productionEnvPlugin","DefinePlugin","NODE_ENV","JSON","stringify","babelLoader","extension","isRelayEnabled","loader","loaders","test","exclude","typescriptLoader","push","options","isProduction","outputFile","Error","vendor","undefined","config","entry","app","output","path","filename","module","devtool","resolve","moduleDirectories","extensions","concat","resolveLoader","fallback","alias","react","plugins","optimize","DedupePlugin","ContextReplacementPlugin","CommonsChunkPlugin","name","cssModules","simpleCssLoader","simpleLoaderAdded","forEach","toString","postcss","require","sources","map","source","simpleRegexWithoutModule","RegExp","addPlugin","flag","plugin","UglifyJsPlugin","minimize","OccurrenceOrderPlugin"],"mappings":"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","file":"webpack-config.js","sourcesContent":["import webpack from 'webpack';\r\nimport fsPath from 'path';\r\nimport { rootModulePath, REACT_PATH } from './paths';\r\n\r\nconst NODE_MODULES_PATH = fsPath.join(rootModulePath(), 'node_modules');\r\nconst UIHARNESS_ENTRY = fsPath.join(__dirname, '../client/ui-harness');\r\n\r\n\r\n\r\n\r\n// HACK (Relay).\r\n//       Prevent error with `fetch` which attempts to look for a `self` object.\r\n//       This occurs when parsing the `react-relay` module on the server while compiling.\r\nglobal.self = { fetch: null };\r\n\r\n\r\n\r\nconst productionEnvPlugin = new webpack.DefinePlugin({\r\n  'process.env': {\r\n    NODE_ENV: JSON.stringify('production'),\r\n  },\r\n});\r\n\r\n\r\n\r\nconst babelLoader = (extension, isRelayEnabled) => {\r\n  const loader = {\r\n    // See: https://github.com/babel/babel-loader#options\r\n    loaders: ['babel'],\r\n    test: extension,\r\n    exclude: /(node_modules|bower_components)/,\r\n  };\r\n\r\n  // Add optional plugins.\r\n  if (isRelayEnabled) {\r\n    loader.loaders[0] += `?plugins[]=${ fsPath.join(__dirname, '../relay/babel-relay-plugin') }`;\r\n  }\r\n\r\n  // Finish up.\r\n  return loader;\r\n};\r\n\r\nconst typescriptLoader = (extension, isRelayEnabled) => {\r\n  // Extend existing config\r\n  const loader = babelLoader(extension, isRelayEnabled);\r\n\r\n  // Add typescript loader\r\n  loader.loaders.push('awesome-typescript-loader');\r\n\r\n  return loader;\r\n};\r\n\r\n\r\n/**\r\n * Creates a Webpack compiler instance.\r\n *\r\n * @param {Object} options:\r\n *            -- entry:           Array of entry paths.\r\n *            -- isProduction:    Flag indicating if the builder is in production mode.\r\n *                                Default: false.\r\n *\r\n *            -- outputFile:      The name of the output file.\r\n *                                Default: 'bundle.js'.\r\n *\r\n *            -- isRelayEnabled:  Flag indicating if relay is being used.\r\n *                                Default: false.\r\n *\r\n *            -- vendor:          An array of vendor modules or entry paths.\r\n *                                Pass empty-array for no vendor modules\r\n *                                otherwise the default set of vendors is included.\r\n *\r\n *            -- cssModules:      An array of regular expressions.\r\n *                                Default: undefined.\r\n *\r\n * @return {Object} compiler.\r\n */\r\nexport default (options = {}) => {\r\n  const isProduction = options.isProduction || false;\r\n  const outputFile = options.outputFile || 'bundle.js';\r\n  const isRelayEnabled = options.isRelayEnabled || false;\r\n\r\n  if (!REACT_PATH) {\r\n    throw new Error('The path to the `react` module was not found. Make sure it is installed');\r\n  }\r\n\r\n  let vendor = options.vendor;\r\n  if (vendor === undefined) {\r\n    vendor = ['react', 'react-dom', 'react-relay', UIHARNESS_ENTRY];\r\n  }\r\n\r\n  const config = {\r\n    entry: {\r\n      app: options.entry,\r\n      vendor,\r\n    },\r\n    output: { path: '/', filename: outputFile },\r\n    module: {\r\n      loaders: [\r\n        babelLoader(/\\.js$/, isRelayEnabled),\r\n        babelLoader(/\\.jsx$/, isRelayEnabled),\r\n        typescriptLoader(/\\.tsx?$/, isRelayEnabled),\r\n        { test: /\\.json$/, loader: 'json' },\r\n        { test: /\\.(png|svg)$/, loader: 'url-loader' },\r\n\r\n        // kjessec; font loader\r\n        { test: /\\.woff$/, loader: 'url?mimetype=application/octet-stream&name=public/fonts/[name].[ext]' },\r\n      ],\r\n    },\r\n    devtool: isProduction ? undefined : 'cheap-module-eval-source-map',\r\n    resolve: {\r\n      moduleDirectories: NODE_MODULES_PATH,\r\n      extensions: [''].concat(\r\n        options.extensions ||\r\n        ['.web.tsx', '.web.ts', '.web.js', '.web.jsx', '.js', '.jsx', '.json', '.ts', '.tsx']\r\n      ),\r\n      resolveLoader: { fallback: NODE_MODULES_PATH },\r\n      alias: {\r\n        react: REACT_PATH, // Lock the bundled version of React to that of the UIHarness.\r\n      },\r\n    },\r\n    plugins: [\r\n      // Remove duplicate code.\r\n      //    See - https://github.com/webpack/docs/wiki/optimization#deduplication\r\n      new webpack.optimize.DedupePlugin(),\r\n\r\n      // [Moment.js] only load subset of locales to reduce size.\r\n      //    See - http://stackoverflow.com/a/25426019/1745661\r\n      new webpack.ContextReplacementPlugin(/moment[/\\\\]locale$/, /en/),\r\n\r\n      // Break out common libs into their own code-chunk.\r\n      //    See - https://webpack.github.io/docs/code-splitting.html#split-app-and-vendor-code\r\n      new webpack.optimize.CommonsChunkPlugin({ name: 'vendor', path: '/', filename: 'vendor.js' }),\r\n    ],\r\n  };\r\n\r\n  // Configure CSS loaders\r\n  const { loaders } = config.module;\r\n  const { cssModules } = options;\r\n  const simpleCssLoader = { test: /\\.css$/, loader: 'style!css' };\r\n  if (cssModules) {\r\n    let simpleLoaderAdded = false;\r\n    cssModules.forEach(test => {\r\n      loaders.push({\r\n        test,\r\n        loaders: [\r\n          'style',\r\n          'css?modules&importLoaders=1&localIdentName=[name]__[local]___[hash:base64:5]',\r\n          'postcss',\r\n        ],\r\n        exclude: /node_modules/,\r\n\r\n        // Loader syntax below from:\r\n        //    https://github.com/css-modules/webpack-demo\r\n      });\r\n      if (test.toString() === simpleCssLoader.test.toString()) {\r\n        simpleLoaderAdded = true;\r\n      }\r\n    });\r\n\r\n    // added: postcss plugins for webpack1\r\n    config.postcss = () => [require('precss'), require('autoprefixer')];\r\n\r\n    // Add the simple CSS loader if the extension was not included for css-module's.\r\n    if (!simpleLoaderAdded) {\r\n\r\n      /*\r\n      We need to exclude all paths meant for css modules from the standard css parser, otherwise\r\n      webpack will run the module code through both matches, which results in the JS being parsed\r\n      as CSS. Eek!\r\n\r\n      To do this, we need to \"exclude\" all the css modules regexes from the standard css regex. We\r\n      can do this using negative lookups.\r\n\r\n      General regex form: /^((?![css_sources joined with |]).)*.[standard_css_source]$/\r\n      Explanation:\r\n      ^ -   need to assert start of string otherwise our negative lookup won't work\r\n      ?! -  negative lookup - don't match what's in this matching group (i.e. parenthesis)\r\n      [css_sources] -   the regexes *not* to match\r\n      | -   a way to join sources as to not match *any* of them\r\n      . -   match any other character, i.e. normal file names with dashes etc.\r\n      * -   match this \"non-matching\" group as many times as necessary\r\n      [standard_css_source] - our existing css file path\r\n      $ -   need to match end of string for same reason as above\r\n\r\n      Refs\r\n      ----\r\n      https://github.com/css-modules/css-modules/pull/65\r\n      http://stackoverflow.com/questions/2078915/a-regular-expression-to-exclude-a-word-stringify\r\n      https://regex101.com/r/gL5lR9/1 (regex tester made to test this code)\r\n      */\r\n\r\n      // We need to extract the regex part inside the // markers - i.e. don't use the string\r\n      // representation\r\n      const sources = cssModules.map(test => test.source);\r\n      const simpleRegexWithoutModule = new RegExp(\r\n        `^((?!${ sources.join('|') }).)*${ simpleCssLoader.test.source }`\r\n      );\r\n\r\n      // Push the new loader onto the list of loaders, but with a different test.\r\n      loaders.push({\r\n        ...simpleCssLoader,\r\n        test: simpleRegexWithoutModule,\r\n      });\r\n    }\r\n  } else {\r\n    // Add simple CSS loader (default).\r\n    loaders.push(simpleCssLoader);\r\n  }\r\n\r\n  // Configure optional plugins.\r\n  //    See - https://webpack.github.io/docs/list-of-plugins.html\r\n  //        - https://github.com/webpack/docs/wiki/optimization\r\n  //\r\n  const addPlugin = (flag, plugin) => { if (flag === true) { config.plugins.push(plugin); } };\r\n  addPlugin(isProduction, new webpack.optimize.UglifyJsPlugin({ minimize: true }));\r\n  addPlugin(isProduction, new webpack.optimize.OccurrenceOrderPlugin(true));\r\n  addPlugin(isProduction, productionEnvPlugin);\r\n\r\n  // Finish up.\r\n  return config;\r\n};\r\n"]}